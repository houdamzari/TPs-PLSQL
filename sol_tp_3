--PROCEDURES

--1
CREATE OR REPLACE PROCEDURE ADDWAREHOUSE(V_WAR_NAME IN WAREHOUSES.WAREHOUSE_NAME%TYPE,V_LOC_ID IN LOCATIONS.LOCATION_ID%TYPE) IS
BEGIN
INSERT INTO WAREHOUSES(WAREHOUSE_NAME,LOCATION_ID) VALUES(V_WAR_NAME,V_LOC_ID);
END;

BEGIN
ADDWAREHOUSE('&WAR_NAME',&LOC_ID);
END;

--2
CREATE OR REPLACE PROCEDURE UPDATEWAREHOUSE(V_WAR_ID  WAREHOUSES.WAREHOUSE_ID%TYPE,V_WAR_NAME IN WAREHOUSES.WAREHOUSE_NAME%TYPE) IS
BEGIN
UPDATE WAREHOUSES SET WAREHOUSE_NAME = V_WAR_NAME WHERE WAREHOUSE_ID = V_WAR_ID;
END;

BEGIN
UPDATEWAREHOUSE(&WAR_HOUSE_ID ,'&WAR_NAME');
END;

--3
CREAT E OR REPLACE PROCEDURE DELETEWAREHOUSE(V_WAR_ID IN WAREHOUSES.WAREHOUSE_ID%TYPE) IS
BEGIN
DELETE FROM WAREHOUSES WHERE WAREHOUSE_ID = V_WAR_ID;
END;

BEGIN
DELETEWAREHOUSE('&WAR_ID');
END;

--4
CREAT E OR REPLACE PROCEDURE SHOWWAREHOUSE(V_LOC_ID IN LOCATIONS.LOCATION_ID%TYPE) IS
CURSOR C_WAR IS SELECT * FROM WAREHOUSES WHERE LOCATION_ID = V_LOC_ID;
BEGIN
FOR I IN C_WAR LOOP
DBMS_OUTPUT.PUT_LINE('ID : ' || I.WAREHOUSE_ID || ' NAME : ' || I.WAREHOUSE_NAME);
END LOOP;
END;

BEGIN
SHOWWAREHOUSE(&LOC_ID);
END;

--5
CREATE OR REPLACE PROCEDURE CALCULECA(V_EMP_ID IN EMPLOYEES.EMPLOYEE_ID%TYPE,V_CA OUT INT) IS
BEGIN
SELECT SUM(QUANTITY*UNIT_PRICE) INTO V_CA FROM ORDERS INNER JOIN ORDER_ITEMS USING(ORDER_ID) WHERE SALESMAN_ID = V_EMP_ID GROUP BY SALESMAN_ID ;
END;

SET SERVEROUTPUT ON;
DECLARE
V_EMPLOYEE_ID EMPLOYEES.EMPLOYEE_ID%TYPE;
V_SALES INT;
BEGIN
V_EMPLOYEE_ID := &EMP_ID;
CALCULECA(&EMP_ID, V_SALES);
DBMS_OUTPUT.PUT_LINE('LE CHIFFRE AFFAIRE DEMPLOYEE ' || V_EMPLOYEE_ID || ' EST ' || V_SALES);
END;


--FUNCTIONS

--1
CREATE OR REPLACE FUNCTION CMDPRICE(V_CUM_ID IN CUSTOMERS.CUSTOMER_ID%TYPE,V_ORD_ID IN ORDERS.ORDER_ID%TYPE) 
RETURN INT
IS
V_VENTE_TOTAL INT;
BEGIN
SELECT SUM(QUANTITY*UNIT_PRICE) INTO V_VENTE_TOTAL FROM ORDERS INNER JOIN ORDER_ITEMS USING(ORDER_ID) WHERE CUSTOMER_ID = V_CUM_ID AND ORDER_ID = V_ORD_ID GROUP BY CUSTOMER_ID ;
RETURN V_VENTE_TOTAL;
END;

SET SERVEROUTPUT ON;
DECLARE
V_CUSTOMER_ID CUSTOMERS.CUSTOMER_ID%TYPE;
V_ORDER_ID ORDERS.ORDER_ID%TYPE;
V_SALES INT;
BEGIN
V_CUSTOMER_ID := &CUM_ID;
V_ORDER_ID := &ORD_ID;
V_SALES := CMDPRICE(V_CUSTOMER_ID,V_ORDER_ID);
DBMS_OUTPUT.PUT_LINE('LE PRIX TOTAL DU COMMANDE ' || V_ORDER_ID || ' DU CLIENT ' || V_CUSTOMER_ID  || ' EST ' || V_SALES);
END;

--2
CREATE OR REPLACE FUNCTION NBPENDING
RETURN INT
IS
V_NB_TOTAL INT;
BEGIN
SELECT COUNT(*) INTO V_NB_TOTAL FROM ORDERS WHERE STATUS = 'Pending';
RETURN V_NB_TOTAL;
END;

SET SERVEROUTPUT ON;
DECLARE
V_NB_PENDING INT;
BEGIN
V_NB_PENDING := NBPENDING();
DBMS_OUTPUT.PUT_LINE('LE NB TOTAL DE COMMANDE QUI ONT LE STATUT PENDING EST ' || V_NB_PENDING);
END;

--DECLENCHEUR

--1
CREATE OR REPLACE TRIGGER RESUME 
BEFORE INSERT ON ORDERS 
FOR EACH ROW
BEGIN
DBMS_OUTPUT.PUT_LINE( 'ORDER ID : '|| :new.order_id );
DBMS_OUTPUT.PUT_LINE( 'CUATOMER ID : '|| :new.customer_id );
DBMS_OUTPUT.PUT_LINE( 'STATUS : '|| :new.status );
END;

--2
CREATE OR REPLACE TRIGGER  ALERT_STOCK
AFTER UPDATE ON INVENTORIES
FOR EACH ROW
WHEN  :NEW.QUANTITY <10
BEGIN
DBMS_OUTPUT.PUT_LINE(' ALERT  DE REPTURE DE STOCK');
END;

--3
CREATE OR REPLACE TRIGGER CREDIT_MODIFY
BEFORE UPDATE OF CREDIT_LINIT 
ON CUSTOMERS 
DECLARE V_DAY NUMBER;
BEGIN
V_DAY := EXTARCT(DAY FROM SYSDATE);
IF V_DAY BETWEEN 28 AND 30 THEN
DBMS_OUTPUT.PUT_LINE(' VOUS NETES PAS AUTORISER DE MODIFIER CREDIT LIMIT');
RAISE_APPLICATION_ERROR(-20100,'CANNOT UPDATE CUSTUMER CREDIT BETWEEN 28 AND 31');
END IF;
END;

--4
CREATE OR REPLACE TRIGGER INTERDIT_AJOUT
BEFORE INSERT ON EMPLOYEES
FOR EACH ROW
WHEN SYSDATE < HIRE_DATE 
DECLARE
RAISE_APPLICATION_ERROR(-20102,'CANNOT INSERT EMPLOYEE UNTIL HIRE DATE IS MORE THAN CURRENT DATE');
BEGIN
DBMS_OUTPUT.PUT_LINE(' VOUS NETES PAS AUTORISER DE MODIFIER CREDIT LIMIT');
END;

--5
CREATE OR REPLACE TRIGGER COMMANDE_REMISE 
BEFORE INSERT ON ORDER_ITEMS
FOR EACH ROW; 
WHEN :NEW.UNIT_PRICE*:NEW.QUANTITY > 10000
BEGIN 
DBMS_OUTPUT.PUT_LINE(' LE MONTANT EST ' ||:NEW.UNIT_PRICE*:NEW.QUANTITY*0.95;); 
END; 

