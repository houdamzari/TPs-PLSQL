------------------ les procedures --------------
***** Q1 ******
DECLARE
    v_warehouse_id  WAREHOUSES.WAREHOUSE_ID%TYPE;
    v_warehouse_name WAREHOUSES.WAREHOUSE_NAME%TYPE;
    v_location_id WAREHOUSES.LOCATION_ID%TYPE;
    PROCEDURE AJOUT_WAREHOUSE(v_warehouse_id IN WAREHOUSES.WAREHOUSE_ID%TYPE,v_warehouse_name IN WAREHOUSES.WAREHOUSE_NAME%TYPE,v_location_id IN WAREHOUSES.LOCATION_ID%TYPE) IS
     BEGIN
     INSERT INTO WAREHOUSES (WAREHOUSE_ID,WAREHOUSE_NAME,LOCATION_ID) 
     VALUES (v_warehouse_id,v_warehouse_name,v_location_id);
    END;
BEGIN
    select max(warehouse_id)+1 INTO v_warehouse_id FROM WAREHOUSES;
    v_warehouse_name:='&v_warehouse_name';
    v_location_id:=&v_location_id;
    AJOUT_WAREHOUSE(v_warehouse_id,v_warehouse_name,v_location_id);
END;

***** Q2 ******

DECLARE
    v_warehouse_name WAREHOUSES.WAREHOUSE_NAME%TYPE;
    v_warehouse_id WAREHOUSES.WAREHOUSE_ID%TYPE;
    v_location_id WAREHOUSES.LOCATION_ID%TYPE

    PROCEDURE UPDATE_WAREHOUSE(v_warehouse_name IN WAREHOUSES.WAREHOUSE_NAME%TYPE,v_location_id IN WAREHOUSES.WAREHOUSE_ID%TYPE)IS
    BEGIN
     UPDATE WAREHOUSES SET WAREHOUSE_NAME = v_warehouse_name WHERE WAREHOUSE_ID = v_warehouse_id;
    END;
BEGIN
    v_location_id:= &v_location_id;
    v_warehouse_name:='&v_warehouse_name';
    UPDATE_WAREHOUSE(v_warehouse_name,v_location_id);
END;

***** Q3 ******
DECLARE
    v_warehouse_id WAREHOUSES.WAREHOUSE_ID%TYPE;
    PROCEDURE DELETE_WAREHOUSE(v_warehouse_id IN WAREHOUSES.WAREHOUSE_ID%TYPE)IS
    BEGIN
     DELETE FROM  WAREHOUSES WHERE WAREHOUSE_ID = v_warehouse_id;
    END;
BEGIN
    v_warehouse_id:=&v_warehouse_id;
    DELETE_WAREHOUSE(v_warehouse_id);
END;

***** Q4 ******
DECLARE
    v_location_id warehouses.location_id%TYPE;
    PROCEDURE Afficher(v_location_id IN warehouses.location_id%TYPE ) IS
     CURSOR tab_names IS
     SELECT WAREHOUSE_ID, WAREHOUSE_NAME FROM WAREHOUSES WHERE LOCATION_ID = v_location_id;
    BEGIN
     for i in tab_names loop
     DBMS_OUTPUT.PUT_LINE('Warehouse ID = '||i.warehouse_id ||' => '||i.warehouse_name);
     end loop;
    END;
BEGIN
    v_location_id:=&v_location_id;
    Afficher(v_location_id);
END;

***** Q5 ******
DECLARE
    v_employee_id EMPLOYEES.EMPLOYEE_ID%TYPE;
    sum1 number;
    PROCEDURE calcul_CA(id_employe IN EMPLOYEES.EMPLOYEE_ID%TYPE,somme OUT number)IS
    BEGIN
     SELECT SUM(QUANTITY*UNIT_PRICE) INTO somme
     FROM ORDERS
     INNER JOIN ORDER_ITEMS USING(ORDER_ID) WHERE SALESMAN_ID=v_employee_id;
    END;
BEGIN
    v_employee_id:=5;
    calcul_CA(v_employee_id,sum1);
    dbms_output.put_line('Le chiffre d affaire de l employe  '||v_employee_id||' est : '|| sum1);
END;


------------------ les fonctions --------------
***** Q1 ******
DECLARE
    v_id NUMBER;
    v_prix_total NUMBER;
    CUSTOMER_ID NUMBER;
     FUNCTION calcul_prix(cust_id NUMBER)
     RETURN NUMBER IS
        prix_total NUMBER;
    BEGIN
        SELECT SUM(UNIT_PRICE) INTO prix_total FROM (ORDERS INNER JOIN ORDER_ITEMS ON ORDERS.ORDER_ID=ORDER_ITEMS.ORDER_ID) 
        INNER JOIN CUSTOMERS ON  CUSTOMERS.CUSTOMER_ID=ORDERS.CUSTOMER_ID WHERE CUSTOMER_ID=cust_id;
    RETURN prix_total;
    END;
    
BEGIN
    v_prix_total := calcul_prix(v_id);
    dbms_output.put_line(v_prix_total);
    
END;

***** Q2 ******

DECLARE
    n_commande number;
    FUNCTION calcul_commande
    RETURN number 
    IS
    nombre number;
    BEGIN
     select count(*) INTO nombre from orders where STATUS='Pending' ;
     return nombre;
    END;
BEGIN
    n_commande:=calcul_commande;
    dbms_output.put_line('Le nombre de commande qui ont comme statut <Pending> est:  '||n_commande);
END;

----------------- les declencheurs --------------
***** Q1 ******
create or replace TRIGGER dec_resum
    BEFORE INSERT ON ORDER_ITEMS
    FOR EACH ROW
DECLARE
BEGIN
    DBMS_OUTPUT.PUT_LINE(' id '|| :new.order_id);  
    DBMS_OUTPUT.PUT_LINE(' id '|| :new.quantity);
    DBMS_OUTPUT.PUT_LINE(' id '|| :new.unit_price);
END;

***** Q2 *****
create or replace  TRIGGER dec_alerte
    AFTER  UPDATE ON INVENTORIES
    FOR EACH ROW
DECLARE
BEGIN
    if :NEW.quantity <10 then
     DBMS_OUTPUT.PUT_LINE('ALERTE => Quantity < 10');
    end if ;
END;

***** Q4 *****

create or replace TRIGGER customers_hire
    BEFORE INSERT ON EMPLOYEES 
    FOR EACH ROW
BEGIN
    IF sysdate < :NEW.hire_date THEN
     raise_application_error(-20102,'Cannot insert until hire date');
    END IF;
END;

***** Q5 ******
CREATE OR REPLACE TRIGGER commande_remise 
    BEFORE INSERT ON ORDER_ITEMS
    FOR EACH ROW; 
    WHEN :NEW.UNIT_PRICE*:NEW.QUANTITY > 10000
BEGIN 
    DBMS_OUTPUT.PUT_LINE(' le montant est ' ||:NEW.UNIT_PRICE*:NEW.QUANTITY*0.95;); 
END; 
